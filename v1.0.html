<html>
<head>
<style>
.hll { background-color: #ffffcc }
.c { color: #888888 } /* Comment */
.err { color: #FF0000; background-color: #FFAAAA } /* Error */
.k { color: #008800; font-weight: bold } /* Keyword */
.o { color: #333333 } /* Operator */
.cm { color: #888888 } /* Comment.Multiline */
.cp { color: #557799 } /* Comment.Preproc */
.c1 { color: #888888 } /* Comment.Single */
.cs { color: #cc0000; font-weight: bold } /* Comment.Special */
.gd { color: #A00000 } /* Generic.Deleted */
.ge { font-style: italic } /* Generic.Emph */
.gr { color: #FF0000 } /* Generic.Error */
.gh { color: #000080; font-weight: bold } /* Generic.Heading */
.gi { color: #00A000 } /* Generic.Inserted */
.go { color: #888888 } /* Generic.Output */
.gp { color: #c65d09; font-weight: bold } /* Generic.Prompt */
.gs { font-weight: bold } /* Generic.Strong */
.gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.gt { color: #0044DD } /* Generic.Traceback */
.kc { color: #008800; font-weight: bold } /* Keyword.Constant */
.kd { color: #008800; font-weight: bold } /* Keyword.Declaration */
.kn { color: #008800; font-weight: bold } /* Keyword.Namespace */
.kp { color: #003388; font-weight: bold } /* Keyword.Pseudo */
.kr { color: #008800; font-weight: bold } /* Keyword.Reserved */
.kt { color: #333399; font-weight: bold } /* Keyword.Type */
.m { color: #6600EE; font-weight: bold } /* Literal.Number */
.s { background-color: #fff0f0 } /* Literal.String */
.na { color: #0000CC } /* Name.Attribute */
.nb { color: #007020 } /* Name.Builtin */
.nc { color: #BB0066; font-weight: bold } /* Name.Class */
.no { color: #003366; font-weight: bold } /* Name.Constant */
.nd { color: #555555; font-weight: bold } /* Name.Decorator */
.ni { color: #880000; font-weight: bold } /* Name.Entity */
.ne { color: #FF0000; font-weight: bold } /* Name.Exception */
.nf { color: #0066BB; font-weight: bold } /* Name.Function */
.nl { color: #997700; font-weight: bold } /* Name.Label */
.nn { color: #0e84b5; font-weight: bold } /* Name.Namespace */
.nt { color: #007700 } /* Name.Tag */
.nv { color: #996633 } /* Name.Variable */
.ow { color: #000000; font-weight: bold } /* Operator.Word */
.w { color: #bbbbbb } /* Text.Whitespace */
.mf { color: #6600EE; font-weight: bold } /* Literal.Number.Float */
.mh { color: #005588; font-weight: bold } /* Literal.Number.Hex */
.mi { color: #0000DD; font-weight: bold } /* Literal.Number.Integer */
.mo { color: #4400EE; font-weight: bold } /* Literal.Number.Oct */
.sb { background-color: #fff0f0 } /* Literal.String.Backtick */
.sc { color: #0044DD } /* Literal.String.Char */
.sd { color: #DD4422 } /* Literal.String.Doc */
.s2 { background-color: #fff0f0 } /* Literal.String.Double */
.se { color: #666666; font-weight: bold; background-color: #fff0f0 } /* Literal.String.Escape */
.sh { background-color: #fff0f0 } /* Literal.String.Heredoc */
.si { background-color: #eeeeee } /* Literal.String.Interpol */
.sx { color: #DD2200; background-color: #fff0f0 } /* Literal.String.Other */
.sr { color: #000000; background-color: #fff0ff } /* Literal.String.Regex */
.s1 { background-color: #fff0f0 } /* Literal.String.Single */
.ss { color: #AA6600 } /* Literal.String.Symbol */
.bp { color: #007020 } /* Name.Builtin.Pseudo */
.vc { color: #336699 } /* Name.Variable.Class */
.vg { color: #dd7700; font-weight: bold } /* Name.Variable.Global */
.vi { color: #3333BB } /* Name.Variable.Instance */
.il { color: #0000DD; font-weight: bold } /* Literal.Number.Integer.Long */
</style>
</head>
<body>
<div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">v1.0</span>
<span class="cm">Second Test Version</span>
<span class="cm">Only Changed Files Shown</span>
<span class="cm">*/</span>

<span class="cm">/* bcast.cpp */</span>
<span class="cp">#include &lt;vector&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;cstring&gt;</span>
<span class="cp">#include &lt;cstdio&gt;</span>
<span class="cp">#include &lt;cerrno&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="cp">#include &lt;termios.h&gt;</span>
<span class="cp">#include &lt;ctime&gt;</span>
<span class="cp">#include &lt;sstream&gt;</span>
<span class="cp">#include &lt;algorithm&gt;</span>
<span class="cp">#include &lt;iterator&gt;</span>
<span class="cp">#include &quot;PracticalSocket.h&quot;</span>
<span class="cp">#include &quot;ident.h&quot;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="cp">#define BUFSIZE 10000 </span><span class="c1">// for modem and gps</span>
<span class="cp">#define SBUFSIZE 50 </span><span class="c1">// for conf updates</span>
<span class="cp">#define ERRORSTRING &quot;ERROR&quot;</span>
<span class="cp">#define SERV_TIME 15</span>
<span class="cp">#define SUPDATE 400 </span><span class="c1">//5 minutes 30 seconds</span>
<span class="cp">#define SIP &quot;/opt/broadcast.sip.conf&quot;</span>
<span class="cp">#define SPORT &quot;/opt/broadcast.sport.conf&quot;</span>
<span class="cp">#define LIP &quot;/opt/broadcast.lip.conf&quot;</span>
<span class="cp">#define LPORT &quot;/opt/broadcast.lport.conf&quot;</span>
<span class="cp">#define DEFAULTIP &quot;24.248.166.184&quot;;</span>
<span class="c1">//#define DEFAULTIP &quot;192.168.96.204&quot;;</span>
<span class="c1">//#define DEFAULTIP &quot;24.248.166.181&quot;;</span>
<span class="cp">#define DEFAULTPORT 4451</span>
<span class="cp">#define FAIL 30 </span><span class="c1">// Maximum # of failiures allowed</span>
<span class="cp">#define BLANKIP &quot;0.0.0.0&quot;</span>

<span class="n">UDPSocket</span> <span class="n">sock</span><span class="p">;</span>

<span class="c1">//send data plus identifying info to host at host port</span>
<span class="kt">bool</span> <span class="nf">bcast</span> <span class="p">(</span><span class="n">string</span> <span class="n">line</span><span class="p">,</span><span class="n">string</span> <span class="n">id</span><span class="p">,</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">hostip</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">destport</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">try</span> <span class="p">{</span>
		<span class="n">string</span> <span class="n">data</span> <span class="o">=</span> <span class="n">line</span> <span class="o">+</span> <span class="s">&quot;,&quot;</span> <span class="o">+</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">sock</span><span class="p">.</span><span class="n">sendTo</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span> <span class="n">hostip</span><span class="p">,</span> <span class="n">destport</span><span class="p">);</span>
		<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Local Port: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sock</span><span class="p">.</span><span class="n">getLocalPort</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">catch</span> <span class="p">(</span><span class="n">SocketException</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sock</span><span class="p">.</span><span class="n">disconnect</span><span class="p">();</span>
	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">updateip</span> <span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">//cout &lt;&lt; &quot;\nUpdating ip\n&quot;;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">SBUFSIZE</span><span class="p">];</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span><span class="n">SBUFSIZE</span><span class="p">);</span>
	<span class="n">string</span> <span class="nf">data</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
	<span class="n">istringstream</span> <span class="nf">ss</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">string</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ss</span> <span class="o">&gt;&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">//cout &lt;&lt; x &lt;&lt; &quot;\n&quot;;</span>
		<span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	cout &lt;&lt; &quot;v 0 &quot; &lt;&lt; v[0] &lt;&lt; &quot;\n&quot;;</span>
<span class="cm">	cout &lt;&lt; &quot;v 1 &quot; &lt;&lt; v[1] &lt;&lt; &quot;\n&quot;;</span>
<span class="cm">	cout &lt;&lt; &quot;v 2 &quot; &lt;&lt; v[2] &lt;&lt; &quot;\n&quot;;</span>
<span class="cm">	*/</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">&gt;</span> <span class="n">updateport</span> <span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">//cout &lt;&lt; &quot;\nUpdating port\n&quot;;</span>
	<span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">SBUFSIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span><span class="n">SBUFSIZE</span><span class="p">);</span>
	<span class="n">string</span> <span class="nf">data</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="n">i</span><span class="p">);</span>
	<span class="n">istringstream</span> <span class="nf">ss</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">string</span> <span class="n">x</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ss</span> <span class="o">&gt;&gt;</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">//cout &lt;&lt; x &lt;&lt; endl;</span>
		<span class="n">stringstream</span> <span class="n">str</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">portshort</span><span class="p">;</span>
		<span class="n">str</span> <span class="o">&gt;&gt;</span> <span class="n">portshort</span><span class="p">;</span>
		<span class="c1">//cout &lt;&lt; portshort &lt;&lt; &quot;\n&quot;;</span>
		<span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">portshort</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	for (int i = 0; i &lt; 3; ++i) {</span>
<span class="cm">		cout &lt;&lt; &quot;V[&quot; &lt;&lt; i &lt;&lt; &quot;]: &quot; &lt;&lt; v[i] &lt;&lt; &quot;\n&quot;;</span>
<span class="cm">	}</span>
<span class="cm">	*/</span>
	<span class="k">return</span> <span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">main</span> <span class="p">()</span> <span class="p">{</span>
	<span class="c1">//string s_ip = DEFAULTIP;</span>
	<span class="c1">//unsigned short us_port = DEFAULTPORT;</span>
	<span class="n">string</span> <span class="n">id</span> <span class="o">=</span> <span class="n">ident</span><span class="p">();</span>
	<span class="kt">int</span> <span class="n">gpsdata</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">gpsdata</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">GPSFile</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_RDONLY</span> <span class="o">|</span> <span class="n">O_NOCTTY</span> <span class="o">|</span> <span class="n">O_NDELAY</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpsdata</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;GPS OPEN&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">gpsdata</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="c1">//cout &lt;&lt; &quot;GPSDATA: &quot; &lt;&lt; gpsdata &lt;&lt; endl;</span>
	<span class="n">fcntl</span><span class="p">(</span><span class="n">gpsdata</span><span class="p">,</span><span class="n">F_SETFL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">ERRORSTRING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">error obtaining id</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">time_t</span> <span class="n">starttime</span><span class="p">;</span>
	<span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starttime</span><span class="p">);</span>
	<span class="kt">time_t</span> <span class="n">curtime</span><span class="p">;</span>
	<span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">curtime</span><span class="p">);</span>
	<span class="kt">double</span> <span class="n">seconds</span><span class="p">;</span>
	<span class="kt">time_t</span> <span class="n">ustarttime</span><span class="p">;</span>
	<span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ustarttime</span><span class="p">);</span>
	<span class="kt">time_t</span> <span class="n">ucurtime</span><span class="p">;</span>
	<span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucurtime</span><span class="p">);</span>
	<span class="kt">double</span> <span class="n">useconds</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">localip</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">&gt;</span> <span class="n">localport</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">serverip</span><span class="p">;</span>
	<span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">&gt;</span> <span class="n">serverport</span><span class="p">;</span>
	<span class="kt">bool</span> <span class="n">first</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lnumip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">snumip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">BUFSIZE</span><span class="p">];</span>
	<span class="n">rl</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">gpsdata</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">BUFSIZE</span><span class="p">);</span>
	<span class="n">lnumip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snumip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">rl</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">//cout &lt;&lt; &quot;Bcast loop\n&quot;;</span>
		<span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucurtime</span><span class="p">);</span>
		<span class="n">useconds</span> <span class="o">=</span> <span class="n">difftime</span><span class="p">(</span><span class="n">ucurtime</span><span class="p">,</span><span class="n">ustarttime</span><span class="p">);</span>
		<span class="c1">//cout &lt;&lt; &quot;USeconds: &quot; &lt;&lt; useconds &lt;&lt; endl;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">useconds</span> <span class="o">&gt;=</span> <span class="n">SUPDATE</span> <span class="o">||</span> <span class="n">first</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Updating Bcast conf</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ustarttime</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">sip</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">SIP</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">sport</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">SPORT</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">lip</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">LIP</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">lport</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">LPORT</span><span class="p">,</span><span class="n">O_RDONLY</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sip</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">sport</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">lip</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">lport</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Failed to open conf files. Retrying...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
				<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;lip: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">lip</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; lport: &quot;</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; sip: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sip</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; sport: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">sport</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">localip</span> <span class="o">=</span> <span class="n">updateip</span><span class="p">(</span><span class="n">lip</span><span class="p">);</span>
			<span class="n">localport</span> <span class="o">=</span> <span class="n">updateport</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
			<span class="n">serverip</span> <span class="o">=</span> <span class="n">updateip</span><span class="p">(</span><span class="n">sip</span><span class="p">);</span>
			<span class="n">serverport</span> <span class="o">=</span> <span class="n">updateport</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
			<span class="n">close</span><span class="p">(</span><span class="n">lip</span><span class="p">);</span>
			<span class="n">close</span><span class="p">(</span><span class="n">lport</span><span class="p">);</span>
			<span class="n">close</span><span class="p">(</span><span class="n">sip</span><span class="p">);</span>
			<span class="n">close</span><span class="p">(</span><span class="n">sport</span><span class="p">);</span>
			<span class="n">first</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Bcast conf updated successfully</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">string</span> <span class="n">alldata</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">rl</span><span class="p">);</span>
		<span class="c1">//cout &lt;&lt; &quot;all data from buf\n&quot;;</span>
		<span class="n">string</span> <span class="n">data</span> <span class="o">=</span> <span class="s">&quot;000&quot;</span><span class="p">;</span>
		<span class="c1">//cout &lt;&lt; &quot;data init\n&quot;;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">alldata</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
			<span class="c1">//cout &lt;&lt; &quot;fill data&quot;;</span>
			<span class="n">data</span> <span class="o">=</span> <span class="n">alldata</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">alldata</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="c1">//cout &lt;&lt; &quot;\nGPS DATA: &quot; &lt;&lt; data &lt;&lt; &quot;\n&quot;;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;$GPRMC&quot;</span><span class="p">);</span>
		<span class="c1">//cout &lt;&lt; &quot;find data\n&quot;;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="c1">//cout &lt;&lt; &quot;\ndata found\n&quot;;</span>
			<span class="n">lnumip</span><span class="o">++</span><span class="p">;</span>
			<span class="c1">//cout &lt;&lt; lnumip &lt;&lt; &quot;\n&quot;;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lnumip</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lnumip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">localip</span><span class="p">[</span><span class="n">lnumip</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BLANKIP</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">bool</span> <span class="n">test</span> <span class="o">=</span> <span class="n">bcast</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">localip</span><span class="p">[</span><span class="n">lnumip</span><span class="p">],</span><span class="n">localport</span><span class="p">[</span><span class="n">lnumip</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test</span><span class="p">)</span> <span class="p">{</span>
					<span class="o">++</span><span class="n">fail</span><span class="p">;</span>
					<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">FAIL: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">fail</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">curtime</span><span class="p">);</span>
			<span class="n">seconds</span> <span class="o">=</span> <span class="n">difftime</span><span class="p">(</span><span class="n">curtime</span><span class="p">,</span><span class="n">starttime</span><span class="p">);</span>
			<span class="c1">//cout &lt;&lt; &quot;Seconds: &quot; &lt;&lt; seconds &lt;&lt; endl;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">snumip</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">snumip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">seconds</span> <span class="o">&gt;=</span> <span class="n">SERV_TIME</span><span class="p">)</span> <span class="p">{</span>
				<span class="c1">//cout &lt;&lt; &quot;\nSERVER\n&quot;;</span>
				<span class="n">time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">starttime</span><span class="p">);</span>
				<span class="k">if</span><span class="p">(</span><span class="n">serverip</span><span class="p">[</span><span class="n">snumip</span><span class="p">]</span> <span class="o">!=</span> <span class="n">BLANKIP</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Trying &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">serverip</span><span class="p">[</span><span class="n">snumip</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
					<span class="kt">bool</span> <span class="n">test</span> <span class="o">=</span> <span class="n">bcast</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">id</span><span class="p">,</span><span class="n">serverip</span><span class="p">[</span><span class="n">snumip</span><span class="p">],</span><span class="n">serverport</span><span class="p">[</span><span class="n">snumip</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test</span><span class="p">)</span> <span class="p">{</span>
						<span class="o">++</span><span class="n">fail</span><span class="p">;</span>
						<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Server FAIL: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">fail</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="o">++</span><span class="n">snumip</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fail</span> <span class="o">&gt;=</span> <span class="n">FAIL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Maximum Failiure. Stopping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="n">close</span><span class="p">(</span><span class="n">gpsdata</span><span class="p">);</span>
			<span class="n">system</span><span class="p">(</span><span class="s">&quot;reboot&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">rl</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">gpsdata</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">BUFSIZE</span><span class="p">);</span>
		<span class="c1">//cout &lt;&lt; &quot;\n&quot;;</span>
	<span class="p">}</span>
	<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Modem has stopped transmitting data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">close</span><span class="p">(</span><span class="n">gpsdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* devdetect.sh */</span>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>
<span class="nv">AWK</span><span class="o">=</span>/usr/bin/awk
<span class="nv">ECHO</span><span class="o">=</span>/bin/echo
<span class="nv">GREP</span><span class="o">=</span>/bin/grep
<span class="nv">UDEVADM</span><span class="o">=</span>/sbin/udevadm
<span class="nv">SED</span><span class="o">=</span>/bin/sed
<span class="nv">TOUCH</span><span class="o">=</span>/bin/touch
<span class="nv">RM</span><span class="o">=</span>/bin/rm

<span class="nv">$TOUCH</span> /opt/udevlock
<span class="nv">udev0</span><span class="o">=</span><span class="k">$(</span><span class="nv">$UDEVADM</span> info -a -n /dev/ttyUSB0<span class="k">)</span>
<span class="nv">udev1</span><span class="o">=</span><span class="k">$(</span><span class="nv">$UDEVADM</span> info -a -n /dev/ttyUSB1<span class="k">)</span>
<span class="nv">udev2</span><span class="o">=</span><span class="k">$(</span><span class="nv">$UDEVADM</span> info -a -n /dev/ttyUSB2<span class="k">)</span>

<span class="nv">$ECHO</span> <span class="nv">$udev0</span> | sed <span class="s2">&quot;s/ /\n/g&quot;</span> | <span class="nv">$GREP</span> -m 1 <span class="s2">&quot;InterfaceNumber&quot;</span> | <span class="nv">$AWK</span> -F<span class="s1">&#39;&quot;&#39;</span> <span class="s1">&#39;{print $2}&#39;</span> &gt; /opt/usb0
<span class="nv">$ECHO</span> <span class="nv">$udev0</span> | sed <span class="s2">&quot;s/ /\n/g&quot;</span> | <span class="nv">$GREP</span> -m 1 <span class="s2">&quot;DRIVERS&quot;</span> | <span class="nv">$AWK</span> -F<span class="s1">&#39;&quot;&#39;</span> <span class="s1">&#39;{print $2}&#39;</span> &gt;&gt; /opt/usb0

<span class="nv">$ECHO</span> <span class="nv">$udev1</span> | sed <span class="s2">&quot;s/ /\n/g&quot;</span> | <span class="nv">$GREP</span> -m 1 <span class="s2">&quot;InterfaceNumber&quot;</span> | <span class="nv">$AWK</span> -F<span class="s1">&#39;&quot;&#39;</span> <span class="s1">&#39;{print $2}&#39;</span> &gt; /opt/usb1
<span class="nv">$ECHO</span> <span class="nv">$udev1</span> | sed <span class="s2">&quot;s/ /\n/g&quot;</span> | <span class="nv">$GREP</span> -m 1 <span class="s2">&quot;DRIVERS&quot;</span> | <span class="nv">$AWK</span> -F<span class="s1">&#39;&quot;&#39;</span> <span class="s1">&#39;{print $2}&#39;</span> &gt;&gt; /opt/usb1

<span class="nv">$ECHO</span> <span class="nv">$udev2</span> | sed <span class="s2">&quot;s/ /\n/g&quot;</span> | <span class="nv">$GREP</span> -m 1 <span class="s2">&quot;InterfaceNumber&quot;</span> | <span class="nv">$AWK</span> -F<span class="s1">&#39;&quot;&#39;</span> <span class="s1">&#39;{print $2}&#39;</span> &gt; /opt/usb2
<span class="nv">$ECHO</span> <span class="nv">$udev2</span> | sed <span class="s2">&quot;s/ /\n/g&quot;</span> | <span class="nv">$GREP</span> -m 1 <span class="s2">&quot;DRIVERS&quot;</span> | <span class="nv">$AWK</span> -F<span class="s1">&#39;&quot;&#39;</span> <span class="s1">&#39;{print $2}&#39;</span> &gt;&gt; /opt/usb2

<span class="nv">$RM</span> /opt/udevlock
</pre></div>
<span class="cm">/* ident.cpp */</span>
<span class="cp">#include &lt;unistd.h&gt;</span>
<span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;string&gt;</span>
<span class="cp">#include &lt;cstring&gt;</span>
<span class="cp">#include &lt;cstdio&gt;</span>
<span class="cp">#include &lt;cerrno&gt;</span>
<span class="cp">#include &lt;fcntl.h&gt;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="cp">#define ERRORSTRING &quot;ERROR&quot;</span>
<span class="cp">#define IDBUFSIZE 10000</span>
<span class="c1">//#define MODEMFILE &quot;/dev/ttyUSB2&quot;</span>
<span class="c1">//#define PERM = O_RDWR | O_NOCTTY | O_NDELAY | O_NONBLOCK;</span>

<span class="c1">//returns location of GPS device for other functions</span>
<span class="kt">int</span> <span class="nf">device</span> <span class="p">()</span> <span class="p">{</span>
	<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">test</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/ttyUSB0&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_NOCTTY</span> <span class="o">|</span> <span class="n">O_NDELAY</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ttyUSB0: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">test</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">IDBUFSIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rb</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">IDBUFSIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">//is this the gps?</span>
		<span class="n">string</span> <span class="n">data</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">rb</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;$&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">!=</span> <span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span>  <span class="p">{</span>
			<span class="n">close</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rb</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="c1">//something went wrong</span>
		<span class="n">perror</span><span class="p">(</span><span class="s">&quot;Open ttyUSB0&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">close</span><span class="p">(</span><span class="n">test</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">test1</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/ttyUSB1&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_NOCTTY</span> <span class="o">|</span> <span class="n">O_NDELAY</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ttyUSB1: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">test1</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf1</span><span class="p">[</span><span class="n">IDBUFSIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rb1</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">test1</span><span class="p">,</span><span class="n">buf1</span><span class="p">,</span><span class="n">IDBUFSIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rb1</span> <span class="o">&gt;</span>  <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">string</span> <span class="n">data1</span><span class="p">(</span><span class="n">buf1</span><span class="p">,</span><span class="n">rb1</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found1</span> <span class="o">=</span> <span class="n">data1</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;$&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found1</span> <span class="o">!=</span> <span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">close</span><span class="p">(</span><span class="n">test1</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rb1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Open ttyUSB1&quot;</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">test1</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">test2</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">&quot;/dev/ttyUSB2&quot;</span><span class="p">,</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_NOCTTY</span> <span class="o">|</span> <span class="n">O_NDELAY</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;ttyUSB2: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">test2</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf2</span><span class="p">[</span><span class="n">IDBUFSIZE</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rb2</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">test</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">IDBUFSIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rb2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">string</span> <span class="n">data2</span><span class="p">(</span><span class="n">buf2</span><span class="p">,</span><span class="n">rb2</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found2</span> <span class="o">=</span> <span class="n">data2</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;$&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found2</span> <span class="o">!=</span> <span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">close</span><span class="p">(</span><span class="n">test2</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rb</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">perror</span><span class="p">(</span><span class="s">&quot;Open ttyUSB2&quot;</span><span class="p">);</span>
	<span class="n">close</span><span class="p">(</span><span class="n">test2</span><span class="p">);</span>
	<span class="c1">//Should never get here</span>
	<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;No Operational Netgear AirCard 341U found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">string</span> <span class="nf">GPSFile</span><span class="p">()</span> <span class="p">{</span>
	<span class="kt">int</span>  <span class="n">dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;/dev/ttyUSB0&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;/dev/ttyUSB1&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;/dev/ttyUSB2&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;-1&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">return</span> <span class="s">&quot;0&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">string</span> <span class="nf">ModemFile</span> <span class="p">()</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;/dev/ttyUSB1&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;/dev/ttyUSB2&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;/dev/ttyUSB3&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">return</span> <span class="s">&quot;-1&quot;</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">return</span> <span class="s">&quot;0&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">string</span> <span class="nf">ident</span> <span class="p">()</span> <span class="p">{</span>
	<span class="n">sleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">modem</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">modem</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">ModemFile</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span> <span class="n">O_RDWR</span> <span class="o">|</span> <span class="n">O_NOCTTY</span> <span class="o">|</span> <span class="n">O_NDELAY</span> <span class="o">|</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">modem</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Modem not open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
			<span class="n">perror</span><span class="p">(</span><span class="s">&quot;MODEM OPEN&quot;</span><span class="p">);</span>
			<span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="n">modem</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">modem open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="n">fcntl</span><span class="p">(</span><span class="n">modem</span><span class="p">,</span> <span class="n">F_SETFL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">inf</span> <span class="p">[</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;ATI1</span><span class="se">\r\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">wb</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">modem</span><span class="p">,</span><span class="n">inf</span><span class="p">,</span><span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wb</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">Error writing modem</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">IDBUFSIZE</span><span class="p">];</span>
	<span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ii</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">modem</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">IDBUFSIZE</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">ii</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> 
		<span class="n">string</span> <span class="n">raw</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ii</span><span class="p">);</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;MEID:&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">!=</span> <span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">string</span> <span class="n">data</span> <span class="o">=</span> <span class="n">raw</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="n">found</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="n">string</span><span class="o">::</span><span class="n">npos</span><span class="p">);</span>
			<span class="c1">//cout &lt;&lt; &quot;Raw: &quot; &lt;&lt; raw &lt;&lt; endl;</span>
			<span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">ID:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">;</span>
			<span class="n">close</span><span class="p">(</span><span class="n">modem</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">data</span><span class="p">.</span><span class="n">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="p">.</span><span class="n">length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ii</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">modem</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">IDBUFSIZE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ERRORSTRING</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">msleep</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">usleep</span><span class="p">(</span><span class="n">seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span> <span class="c1">//takes microseconds</span>
<span class="p">}</span>

<span class="cm">/* ident.h */</span>
<span class="cp">#ifndef _IDENT_H</span>
<span class="cp">#define _IDENT_H</span>
<span class="cp">#include &lt;string&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ident</span> <span class="p">();</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="nf">c_ident</span><span class="p">();</span>
<span class="kt">void</span> <span class="nf">msleep</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">seconds</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">GPSFile</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">ModemFile</span><span class="p">();</span>
<span class="kt">int</span> <span class="nf">device</span><span class="p">();</span>
<span class="cp">#endif</span>
</pre></div>
</body>
</html>
